# H∆∞·ªõng d·∫´n ƒêi·ªÅu ki·ªán s·ª≠ d·ª•ng M√£ khuy·∫øn m√£i

## T·ªïng quan

H·ªá th·ªëng khuy·∫øn m√£i c√≥ nhi·ªÅu ƒëi·ªÅu ki·ªán kh√°c nhau ƒë·ªÉ ƒë·∫£m b·∫£o m√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë√∫ng c√°ch v√† hi·ªáu qu·∫£. M√£ khuy·∫øn m√£i s·∫Ω t·ª± ƒë·ªông thay ƒë·ªïi m√†u s·∫Øc theo tr·∫°ng th√°i hi·ªáu l·ª±c.

## üéØ **C√°c ƒëi·ªÅu ki·ªán s·ª≠ d·ª•ng m√£ khuy·∫øn m√£i**

### **1. ƒêi·ªÅu ki·ªán c∆° b·∫£n**

#### **‚úÖ Tr·∫°ng th√°i khuy·∫øn m√£i**
- **ACTIVE**: M√£ ƒëang ho·∫°t ƒë·ªông
- **INACTIVE**: M√£ kh√¥ng kh·∫£ d·ª•ng
- **SCHEDULED**: M√£ ƒë√£ l√™n l·ªãch nh∆∞ng ch∆∞a c√≥ hi·ªáu l·ª±c
- **EXPIRED**: M√£ ƒë√£ h·∫øt h·∫°n
- **ARCHIVED**: M√£ ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ

#### **‚úÖ Th·ªùi gian hi·ªáu l·ª±c**
- **ƒêang hi·ªáu l·ª±c**: `start_date <= now <= end_date`
- **S·∫Øp c√≥ hi·ªáu l·ª±c**: `now < start_date`
- **ƒê√£ h·∫øt h·∫°n**: `now > end_date`

#### **‚úÖ Gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu**
- **minimum_appointment_value**: Gi√° tr·ªã t·ªëi thi·ªÉu ƒë·ªÉ √°p d·ª•ng m√£
- **V√≠ d·ª•**: M√£ gi·∫£m 20% cho ƒë∆°n t·ª´ 500,000ƒë

#### **‚úÖ Gi·ªõi h·∫°n s·ª≠ d·ª•ng**
- **usage_limit_per_customer**: S·ªë l·∫ßn t·ªëi ƒëa m·ªói kh√°ch h√†ng c√≥ th·ªÉ s·ª≠ d·ª•ng
- **total_usage_limit**: T·ªïng s·ªë l·∫ßn t·ªëi ƒëa m√£ c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng
- **current_usage_count**: S·ªë l·∫ßn ƒë√£ s·ª≠ d·ª•ng hi·ªán t·∫°i

### **2. ƒêi·ªÅu ki·ªán kh√°ch h√†ng (Customer Condition)**

#### **ALL**: T·∫•t c·∫£ kh√°ch h√†ng
- √Åp d·ª•ng cho m·ªçi lo·∫°i kh√°ch h√†ng
- Kh√¥ng c√≥ gi·ªõi h·∫°n v·ªÅ s·ªë l∆∞·ª£ng ng∆∞·ªùi

#### **INDIVIDUAL**: Kh√°ch h√†ng c√° nh√¢n
- Ch·ªâ √°p d·ª•ng cho booking c√≥ 1 ng∆∞·ªùi
- Ph√π h·ª£p cho d·ªãch v·ª• c√° nh√¢n

#### **COUPLE**: Kh√°ch h√†ng ƒëi c·∫∑p
- Ch·ªâ √°p d·ª•ng cho booking c√≥ 2 ng∆∞·ªùi
- Ph√π h·ª£p cho d·ªãch v·ª• c·∫∑p ƒë√¥i

#### **GROUP**: Kh√°ch h√†ng ƒëi nh√≥m
- Ch·ªâ √°p d·ª•ng cho booking c√≥ 3+ ng∆∞·ªùi
- Ph√π h·ª£p cho d·ªãch v·ª• nh√≥m

### **3. Ph·∫°m vi √°p d·ª•ng (Applicable Scope)**

#### **ENTIRE_APPOINTMENT**: To√†n b·ªô l·ªãch h·∫πn
- √Åp d·ª•ng cho to√†n b·ªô gi√° tr·ªã l·ªãch h·∫πn
- M·∫∑c ƒë·ªãnh cho h·∫ßu h·∫øt khuy·∫øn m√£i

#### **SPECIFIC_SERVICES**: D·ªãch v·ª• c·ª• th·ªÉ
- Ch·ªâ √°p d·ª•ng cho c√°c d·ªãch v·ª• ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh
- L∆∞u danh s√°ch service IDs trong JSON

#### **ALL_SERVICES**: T·∫•t c·∫£ d·ªãch v·ª•
- √Åp d·ª•ng cho m·ªçi d·ªãch v·ª•
- Linh ho·∫°t nh·∫•t

## üé® **H·ªá th·ªëng m√†u s·∫Øc theo tr·∫°ng th√°i**

### **1. Badge tr·∫°ng th√°i**

#### **üî¥ ƒê√£ h·∫øt h·∫°n (bg-red-100 text-red-800)**
```html
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
    <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
    ƒê√£ h·∫øt h·∫°n
</span>
```
- **ƒêi·ªÅu ki·ªán**: `end_date < now`
- **√ù nghƒ©a**: M√£ kh√¥ng c√≤n hi·ªáu l·ª±c

#### **üü° S·∫Øp c√≥ hi·ªáu l·ª±c (bg-yellow-100 text-yellow-800)**
```html
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
    <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
    S·∫Øp c√≥ hi·ªáu l·ª±c
</span>
```
- **ƒêi·ªÅu ki·ªán**: `start_date > now`
- **√ù nghƒ©a**: M√£ ch∆∞a c√≥ hi·ªáu l·ª±c nh∆∞ng s·∫Ω c√≥ trong t∆∞∆°ng lai

#### **üü¢ ƒêang hi·ªáu l·ª±c (bg-green-100 text-green-800)**
```html
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
    <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
    C√≤n 2 l∆∞·ª£t
</span>
```
- **ƒêi·ªÅu ki·ªán**: `start_date <= now <= end_date` v√† c√≤n l∆∞·ª£t s·ª≠ d·ª•ng
- **√ù nghƒ©a**: M√£ c√≥ th·ªÉ s·ª≠ d·ª•ng

#### **üîµ Kh√¥ng gi·ªõi h·∫°n (bg-blue-100 text-blue-800)**
```html
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
    <i data-lucide="infinity" class="w-3 h-3 mr-1"></i>
    Kh√¥ng gi·ªõi h·∫°n
</span>
```
- **ƒêi·ªÅu ki·ªán**: `usage_limit_per_customer IS NULL`
- **√ù nghƒ©a**: Kh√¥ng c√≥ gi·ªõi h·∫°n s·ªë l·∫ßn s·ª≠ d·ª•ng

#### **‚ö´ Kh√¥ng kh·∫£ d·ª•ng (bg-gray-100 text-gray-800)**
```html
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
    <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>
    Kh√¥ng kh·∫£ d·ª•ng
</span>
```
- **ƒêi·ªÅu ki·ªán**: `status != 'ACTIVE'`
- **√ù nghƒ©a**: M√£ b·ªã t·∫Øt ho·∫∑c kh√¥ng ho·∫°t ƒë·ªông

### **2. Logic hi·ªÉn th·ªã m√†u s·∫Øc**

```java
// Trong JSP
<c:set var="now" value="<%= java.time.LocalDateTime.now() %>" />
<c:choose>
    <c:when test="${promotion.status != 'ACTIVE'}">
        <!-- M√†u x√°m - Kh√¥ng kh·∫£ d·ª•ng -->
    </c:when>
    <c:when test="${promotion.endDate < now}">
        <!-- M√†u ƒë·ªè - ƒê√£ h·∫øt h·∫°n -->
    </c:when>
    <c:when test="${promotion.startDate > now}">
        <!-- M√†u v√†ng - S·∫Øp c√≥ hi·ªáu l·ª±c -->
    </c:when>
    <c:otherwise>
        <!-- M√†u xanh - ƒêang hi·ªáu l·ª±c -->
    </c:otherwise>
</c:choose>
```

## üîß **Validation Logic**

### **1. Ki·ªÉm tra ƒëi·ªÅu ki·ªán s·ª≠ d·ª•ng**

```java
// Trong PromotionService.validatePromotion()
private String validatePromotion(Promotion promotion, Integer customerId, BigDecimal orderAmount) {
    LocalDateTime now = LocalDateTime.now();
    
    // 1. Ki·ªÉm tra tr·∫°ng th√°i
    if (!"ACTIVE".equals(promotion.getStatus())) {
        return "M√£ khuy·∫øn m√£i hi·ªán kh√¥ng kh·∫£ d·ª•ng";
    }
    
    // 2. Ki·ªÉm tra th·ªùi gian hi·ªáu l·ª±c
    if (promotion.getStartDate() != null && now.isBefore(promotion.getStartDate())) {
        return "M√£ khuy·∫øn m√£i ch∆∞a c√≥ hi·ªáu l·ª±c";
    }
    
    if (promotion.getEndDate() != null && now.isAfter(promotion.getEndDate())) {
        return "M√£ khuy·∫øn m√£i ƒë√£ h·∫øt h·∫°n";
    }
    
    // 3. Ki·ªÉm tra gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu
    if (promotion.getMinimumAppointmentValue() != null && 
        orderAmount.compareTo(promotion.getMinimumAppointmentValue()) < 0) {
        return String.format("ƒê∆°n h√†ng t·ªëi thi·ªÉu ph·∫£i t·ª´ %.0f VND ƒë·ªÉ s·ª≠ d·ª•ng m√£ n√†y", 
                           promotion.getMinimumAppointmentValue().doubleValue());
    }
    
    // 4. Ki·ªÉm tra gi·ªõi h·∫°n s·ª≠ d·ª•ng
    if (promotion.getUsageLimitPerCustomer() != null) {
        int customerUsageCount = promotionUsageDAO.getCustomerUsageCount(promotion.getPromotionId(), customerId);
        if (customerUsageCount >= promotion.getUsageLimitPerCustomer()) {
            return "B·∫°n ƒë√£ s·ª≠ d·ª•ng h·∫øt s·ªë l·∫ßn cho ph√©p v·ªõi m√£ n√†y";
        }
    }
    
    // 5. Ki·ªÉm tra ƒëi·ªÅu ki·ªán kh√°ch h√†ng
    if (promotion.getCustomerCondition() != null && !"ALL".equals(promotion.getCustomerCondition())) {
        String customerConditionError = validateCustomerCondition(promotion.getCustomerCondition(), customerId);
        if (customerConditionError != null) {
            return customerConditionError;
        }
    }
    
    return null; // H·ª£p l·ªá
}
```

### **2. Ki·ªÉm tra ƒëi·ªÅu ki·ªán kh√°ch h√†ng**

```java
private String validateCustomerCondition(String customerCondition, Integer customerId) {
    // TODO: Implement actual booking validation
    switch (customerCondition) {
        case "INDIVIDUAL":
            // Ki·ªÉm tra booking c√≥ 1 ng∆∞·ªùi
            return validateIndividualBooking(customerId);
        case "COUPLE":
            // Ki·ªÉm tra booking c√≥ 2 ng∆∞·ªùi
            return validateCoupleBooking(customerId);
        case "GROUP":
            // Ki·ªÉm tra booking c√≥ 3+ ng∆∞·ªùi
            return validateGroupBooking(customerId);
        default:
            return null; // ALL condition
    }
}
```

## üìä **V√≠ d·ª• th·ª±c t·∫ø**

### **1. M√£ gi·∫£m 20% cho ƒë∆°n t·ª´ 500K**
```sql
INSERT INTO promotions (
    title, promotion_code, discount_type, discount_value,
    minimum_appointment_value, customer_condition, status
) VALUES (
    'Gi·∫£m 20% cho ƒë∆°n t·ª´ 500K', 'MIN500K20', 'PERCENTAGE', 20.00,
    500000.00, 'ALL', 'ACTIVE'
);
```

**ƒêi·ªÅu ki·ªán s·ª≠ d·ª•ng:**
- ‚úÖ Tr·∫°ng th√°i: ACTIVE
- ‚úÖ Th·ªùi gian: ƒêang hi·ªáu l·ª±c
- ‚úÖ Gi√° tr·ªã ƒë∆°n: ‚â• 500,000ƒë
- ‚úÖ Kh√°ch h√†ng: T·∫•t c·∫£
- ‚úÖ Gi·ªõi h·∫°n: Theo c·∫•u h√¨nh

### **2. M√£ gi·∫£m 25% cho c·∫∑p ƒë√¥i**
```sql
INSERT INTO promotions (
    title, promotion_code, discount_type, discount_value,
    customer_condition, status
) VALUES (
    'Gi·∫£m 25% cho c·∫∑p ƒë√¥i', 'COUPLE25', 'PERCENTAGE', 25.00,
    'COUPLE', 'ACTIVE'
);
```

**ƒêi·ªÅu ki·ªán s·ª≠ d·ª•ng:**
- ‚úÖ Tr·∫°ng th√°i: ACTIVE
- ‚úÖ Th·ªùi gian: ƒêang hi·ªáu l·ª±c
- ‚úÖ Gi√° tr·ªã ƒë∆°n: Kh√¥ng gi·ªõi h·∫°n
- ‚úÖ Kh√°ch h√†ng: Ch·ªâ c·∫∑p ƒë√¥i (2 ng∆∞·ªùi)
- ‚úÖ Gi·ªõi h·∫°n: Theo c·∫•u h√¨nh

## üß™ **Testing**

### **1. Ch·∫°y test script**
```sql
-- Ch·∫°y file: test_promotion_conditions.sql
-- Script n√†y s·∫Ω t·∫°o d·ªØ li·ªáu test v√† ki·ªÉm tra c√°c ƒëi·ªÅu ki·ªán
```

### **2. Test cases**
- **Test gi√° tr·ªã t·ªëi thi·ªÉu**: ƒê∆°n 300K vs 500K requirement
- **Test customer condition**: INDIVIDUAL, COUPLE, GROUP
- **Test th·ªùi gian hi·ªáu l·ª±c**: H·∫øt h·∫°n, s·∫Øp c√≥ hi·ªáu l·ª±c, ƒëang hi·ªáu l·ª±c
- **Test gi·ªõi h·∫°n s·ª≠ d·ª•ng**: H·∫øt l∆∞·ª£t, c√≤n l∆∞·ª£t, kh√¥ng gi·ªõi h·∫°n

### **3. Expected results**
```
MIN500K20 - 300K order: "Kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán. C·∫ßn t·ªëi thi·ªÉu 500,000 VND"
MIN500K20 - 600K order: "C√≥ th·ªÉ s·ª≠ d·ª•ng"
COUPLE25 - 2 people: "H·ª£p l·ªá - Kh√°ch h√†ng ƒëi c·∫∑p"
EXPIRED10: "ƒê√£ h·∫øt h·∫°n" (m√†u ƒë·ªè)
FUTURE20: "S·∫Øp c√≥ hi·ªáu l·ª±c" (m√†u v√†ng)
```

## üöÄ **Implementation**

### **1. Frontend (JSP)**
- ‚úÖ **Dynamic color badges**: Thay ƒë·ªïi m√†u theo tr·∫°ng th√°i
- ‚úÖ **Condition display**: Hi·ªÉn th·ªã ƒëi·ªÅu ki·ªán s·ª≠ d·ª•ng
- ‚úÖ **Action buttons**: Ch·ªâ hi·ªÉn th·ªã khi c√≥ th·ªÉ s·ª≠ d·ª•ng

### **2. Backend (Java)**
- ‚úÖ **Validation service**: Ki·ªÉm tra t·∫•t c·∫£ ƒëi·ªÅu ki·ªán
- ‚úÖ **Error messages**: Th√¥ng b√°o l·ªói r√µ r√†ng
- ‚úÖ **Usage tracking**: Theo d√µi s·ªë l·∫ßn s·ª≠ d·ª•ng

### **3. Database**
- ‚úÖ **Constraints**: ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu
- ‚úÖ **Indexes**: T·ªëi ∆∞u hi·ªáu su·∫•t query
- ‚úÖ **Triggers**: T·ª± ƒë·ªông c·∫≠p nh·∫≠t usage count

## üì± **User Experience**

### **1. Visual Feedback**
- **M√†u s·∫Øc tr·ª±c quan**: Kh√°ch h√†ng d·ªÖ d√†ng nh·∫≠n bi·∫øt tr·∫°ng th√°i
- **Icons r√µ r√†ng**: S·ª≠ d·ª•ng Lucide icons cho t·ª´ng tr·∫°ng th√°i
- **Progress bars**: Hi·ªÉn th·ªã t·ª∑ l·ªá s·ª≠ d·ª•ng

### **2. Clear Information**
- **ƒêi·ªÅu ki·ªán chi ti·∫øt**: Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß ƒëi·ªÅu ki·ªán s·ª≠ d·ª•ng
- **Th√¥ng b√°o l·ªói**: Gi·∫£i th√≠ch r√µ t·∫°i sao kh√¥ng th·ªÉ s·ª≠ d·ª•ng
- **H∆∞·ªõng d·∫´n**: C√°ch s·ª≠ d·ª•ng m√£ khuy·∫øn m√£i

### **3. Responsive Design**
- **Mobile-friendly**: T·ªëi ∆∞u cho m√†n h√¨nh nh·ªè
- **Touch-friendly**: Buttons d·ªÖ nh·∫•n tr√™n mobile
- **Fast loading**: T·ªëi ∆∞u hi·ªáu su·∫•t

## üîí **Security & Validation**

### **1. Server-side validation**
- ‚úÖ **Always validate**: Kh√¥ng tin t∆∞·ªüng client-side validation
- ‚úÖ **SQL injection protection**: S·ª≠ d·ª•ng PreparedStatement
- ‚úÖ **Input sanitization**: L√†m s·∫°ch d·ªØ li·ªáu ƒë·∫ßu v√†o

### **2. Business logic**
- ‚úÖ **Atomic operations**: ƒê·∫£m b·∫£o t√≠nh nh·∫•t qu√°n d·ªØ li·ªáu
- ‚úÖ **Transaction management**: Rollback khi c√≥ l·ªói
- ‚úÖ **Audit trail**: Ghi log m·ªçi thao t√°c

## üìû **Support**

N·∫øu c√≥ v·∫•n ƒë·ªÅ ho·∫∑c c·∫ßn h·ªó tr·ª£:
1. Ki·ªÉm tra logs trong `PromotionService`
2. Verify database data v·ªõi test script
3. Check validation logic
4. Review UI/UX implementation 